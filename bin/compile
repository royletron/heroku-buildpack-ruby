#!/usr/bin/env ruby

# sync output
$stdout.sync = true

BUILD_DIR=ARGV[0]
CACHE_DIR=ARGV[1]
PYPY_DIR=CACHE_DIR+'/pypy-1.8'
VENDORED_PYPY="https://bitbucket.org/pypy/pypy/downloads/pypy-1.8-linux64.tar.bz2"

puts "-----> Making Dirs        : "+%x[mkdir -p #{CACHE_DIR}]
puts "-----> Downloading Pypy   : "+%x[cd #{CACHE_DIR}; curl -sLO #{VENDORED_PYPY}]
puts "-----> Delete old dir     : "+%x[rm -fr #{CACHE_DIR}/pypy-1.8]
puts "-----> Making new dir     : "+%x[mkdir #{CACHE_DIR}/pypy-1.8]
puts "-----> Extracting Tarball : "+%x[tar -jxf #{CACHE_DIR}/pypy-1.8-linux64.tar.bz2 -C #{PYPY_DIR} --strip-components 1]

$:.unshift File.expand_path("../../lib", __FILE__)
require "language_pack"

LanguagePack::Instrument.trace 'compile', 'app.compile' do
  if pack = LanguagePack.detect(ARGV[0], ARGV[1])
    pack.log("compile") do
      pack.compile
    end
  end
end
